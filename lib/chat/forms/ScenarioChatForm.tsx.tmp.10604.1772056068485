'use client';

import { useState, useRef } from 'react';
import { S } from './chatFormStyles';

interface Props {
  onSubmit: (data: Record<string, unknown>) => void;
  onCancel: () => void;
  isLoading: boolean;
}

const templates = [
  { value: 'presentation', label: 'ë°œí‘œ(PT)', icon: 'ğŸ¯' },
  { value: 'meeting',      label: 'íšŒì˜ ì§„í–‰', icon: 'ğŸ‘¥' },
  { value: 'mc',           label: 'ì‚¬íšŒì',    icon: 'ğŸ¤' },
  { value: 'briefing',     label: 'ë¸Œë¦¬í•‘',    icon: 'ğŸ“¢' },
  { value: 'lecture',      label: 'ê°•ì˜',      icon: 'ğŸ“š' },
  { value: 'debate',       label: 'í† ë¡ ',      icon: 'ğŸ’¬' },
];

export default function ScenarioChatForm({ onSubmit, onCancel, isLoading }: Props) {
  const [content, setContent]     = useState('');
  const [template, setTemplate]   = useState('presentation');
  const [style, setStyle]         = useState('formal');
  const [audience, setAudience]   = useState('general');
  const [duration, setDuration]   = useState('medium');
  const [uploadedFile, setUploadedFile] = useState<File | null>(null);
  const [isProcessing, setIsProcessing] = useState(false);
  const fileRef = useRef<HTMLInputElement>(null);

  async function processFile(file: File) {
    const allowed = ['application/pdf', 'text/plain'];
    if (!allowed.includes(file.type)) { alert('PDF ë˜ëŠ” TXT íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
    setIsProcessing(true);
    setUploadedFile(file);
    try {
      const fd = new FormData();
      fd.append('file', file);
      const res = await fetch('/api/work-support/scenario-generator/extract', { method: 'POST', body: fd });
      if (!res.ok) throw new Error((await res.json()).error || 'íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨');
      setContent((await res.json()).text);
    } catch (err) {
      alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + (err instanceof Error ? err.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    } finally {
      setIsProcessing(false);
    }
  }

  function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (!content.trim()) return;
    onSubmit({ content, template, settings: { style, audience, duration } });
  }

  return (
    <form onSubmit={handleSubmit} style={S.card}>
      <div style={S.header}>
        <h3 style={S.h3}>ğŸ­ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±</h3>
        <p style={S.desc}>ë°œí‘œ ëŒ€ë³¸ìœ¼ë¡œ ë³€í™˜í•  ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
      </div>

      <div style={S.content}>
        {/* ìƒí™© ì„¤ì • */}
        <div>
          <label style={S.label}>ìƒí™© ì„¤ì •</label>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '0.3rem' }}>
            {templates.map(t => (
              <label
                key={t.value}
                style={{
                  display: 'flex', alignItems: 'center', justifyContent: 'center',
                  gap: '0.25rem', padding: '0.3rem',
                  border: `1px solid ${template === t.value ? '#2383e2' : '#e0e0e0'}`,
                  borderRadius: '4px', cursor: 'pointer', fontSize: '0.78rem',
                  background: template === t.value ? '#e8f4ff' : '#f9fafb',
                  color: template === t.value ? '#2383e2' : '#6b6b6b',
                  fontWeight: template === t.value ? 600 : 400,
                }}
              >
                <input type="radio" value={t.value} checked={template === t.value} onChange={() => setTemplate(t.value)} style={{ display: 'none' }} />
                <span>{t.icon}</span>
                <span>{t.label}</span>
              </label>
            ))}
          </div>
        </div>

        {/* ê¸°ë³¸ ì„¤ì • */}
        <div>
          <label style={S.label}>ê¸°ë³¸ ì„¤ì •</label>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '0.3rem' }}>
            <select style={S.input} value={style} onChange={e => setStyle(e.target.value)} disabled={isLoading}>
              <option value="formal">ê²©ì‹</option>
              <option value="conversational">ëŒ€í™”í˜•</option>
              <option value="casual">í¸ì•ˆí•¨</option>
            </select>
            <select style={S.input} value={audience} onChange={e => setAudience(e.target.value)} disabled={isLoading}>
              <option value="general">ì¼ë°˜</option>
              <option value="colleagues">ë™ë£Œ</option>
              <option value="citizens">ì‹œë¯¼</option>
              <option value="students">í•™ìƒ</option>
            </select>
            <select style={S.input} value={duration} onChange={e => setDuration(e.target.value)} disabled={isLoading}>
              <option value="short">3-5ë¶„</option>
              <option value="medium">5-10ë¶„</option>
              <option value="long">10-15ë¶„</option>
            </select>
          </div>
        </div>

        {/* íŒŒì¼ ì—…ë¡œë“œ */}
        <div>
          <label style={S.label}>íŒŒì¼ ì—…ë¡œë“œ (ì„ íƒ)</label>
          {uploadedFile ? (
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.4rem', background: '#f7f6f3', borderRadius: '4px', border: '1px solid #e0e0e0' }}>
              <span style={{ fontSize: '0.65rem', color: '#37352f' }}>ğŸ“„ {uploadedFile.name}</span>
              <button type="button" onClick={() => { setUploadedFile(null); setContent(''); }} style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#6b6b6b', fontSize: '0.75rem' }}>âœ•</button>
            </div>
          ) : (
            <div
              style={{ border: '1px dashed #d1d5db', borderRadius: '4px', background: '#fafafa', cursor: 'pointer' }}
              onClick={() => fileRef.current?.click()}
            >
              <label style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.3rem', padding: '0.4rem', cursor: 'pointer', color: '#6b6b6b', fontSize: '0.65rem' }}>
                {isProcessing ? 'â³ ì²˜ë¦¬ ì¤‘...' : 'ğŸ“ PDF/TXT ì—…ë¡œë“œ'}
              </label>
              <input ref={fileRef} type="file" accept=".pdf,.txt" style={{ display: 'none' }} onChange={e => e.target.files?.[0] && processFile(e.target.files[0])} disabled={isProcessing} />
            </div>
          )}
        </div>

        {/* ì›ë³¸ í…ìŠ¤íŠ¸ */}
        <div>
          <label style={S.label}>ì›ë³¸ í…ìŠ¤íŠ¸ *</label>
          <textarea
            style={{ ...S.input, resize: 'vertical', minHeight: '80px', lineHeight: 1.4 }}
            placeholder="ëŒ€ë³¸ìœ¼ë¡œ ë³€í™˜í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
            value={content}
            onChange={e => setContent(e.target.value)}
            disabled={isLoading}
          />
        </div>
      </div>

      <div style={S.actions}>
        <button type="button" style={S.cancelBtn} onClick={onCancel} disabled={isLoading}>ì·¨ì†Œ</button>
        <button type="submit" style={{ ...S.submitBtn, flex: 2, opacity: !content.trim() || isLoading ? 0.5 : 1 }} disabled={!content.trim() || isLoading}>
          {isLoading ? 'ìƒì„± ì¤‘...' : 'ëŒ€ë³¸ ìƒì„±'}
        </button>
      </div>
    </form>
  );
}
