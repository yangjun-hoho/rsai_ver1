'use client';

import type { ToolId } from '@/lib/chat/Sidebar';
import GreetingDisplay from '@/lib/work-support/greetings/GreetingDisplay';
import PressReleaseDisplay from '@/lib/work-support/press-release/PressReleaseDisplay';
import CitationDisplay from '@/lib/work-support/merit-citation/CitationDisplay';
import ReportViewer from '@/lib/work-support/report/ReportViewer';
import ScenarioViewer from '@/lib/work-support/scenario-generator/ScenarioViewer';
import PPTViewer from '@/lib/work-support/ppt-converter/PPTViewer';

interface SlideType {
  slideNumber: number;
  title: string;
  content: string;
  bulletPoints: string[];
  type: string;
  subtitle?: string;
}

export interface PreviewPanelProps {
  tool: ToolId | null;
  data: Record<string, unknown> | null;
  isLoading: boolean;
  isOpen: boolean;
  onClose: () => void;
  onToggle: () => void;
}

const TOOL_TITLES: Record<string, string> = {
  report:          'ğŸ“ ë³´ê³ ì„œ ìƒì„±',
  ppt:             'ğŸ–¥ï¸ PPT ìƒì„±',
  scenario:        'ğŸ­ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±',
  'merit-citation': 'ğŸ† ê³µì ì¡°ì„œ ìƒì„±',
  greetings:       'ğŸ’¬ ì¸ì‚¬ë§ì”€ ìƒì„±',
  'press-release': 'ğŸ“° ë³´ë„ìë£Œ ìƒì„±',
};

const TOOL_EMOJI: Record<string, string> = {
  report:          'ğŸ“',
  ppt:             'ğŸ–¥ï¸',
  scenario:        'ğŸ­',
  'merit-citation': 'ğŸ†',
  greetings:       'ğŸ’¬',
  'press-release': 'ğŸ“°',
};

function PanelLoading({ text }: { text: string }) {
  return (
    <div style={{
      display: 'flex', flexDirection: 'column', alignItems: 'center',
      justifyContent: 'center', height: '100%', gap: '1rem',
    }}>
      <div className="loading-spinner" />
      <p style={{ color: '#9b9a97', margin: 0, fontSize: '0.9rem' }}>{text}</p>
    </div>
  );
}

export default function PreviewPanel({ tool, data, isLoading, isOpen, onClose, onToggle }: PreviewPanelProps) {
  // íŒ¨ë„ì´ ì—†ì„ ë•ŒëŠ” ë Œë”ë§í•˜ì§€ ì•ŠìŒ
  if (!tool) return null;

  const title = TOOL_TITLES[tool] || tool;
  const emoji = TOOL_EMOJI[tool] || 'ğŸ”§';

  // â”€â”€ ì ‘íŒ ìƒíƒœ (44px ì„¸ë¡œ ë ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (!isOpen) {
    return (
      <div style={{
        width: '44px',
        flexShrink: 0,
        borderLeft: '1px solid #e9e9e7',
        background: '#f7f6f3',
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        paddingTop: '0.6rem',
        gap: '0.75rem',
        overflow: 'hidden',
      }}>
        {/* í¼ì¹˜ê¸° ë²„íŠ¼ */}
        <button
          onClick={onToggle}
          title="ë¯¸ë¦¬ë³´ê¸° í¼ì¹˜ê¸°"
          style={{
            width: '30px', height: '30px',
            display: 'flex', alignItems: 'center', justifyContent: 'center',
            border: 'none', background: 'transparent', borderRadius: '6px',
            cursor: 'pointer', color: '#555', flexShrink: 0,
          }}
          onMouseEnter={e => (e.currentTarget.style.background = 'rgba(0,0,0,0.08)')}
          onMouseLeave={e => (e.currentTarget.style.background = 'transparent')}
        >
          {/* ì™¼ìª½ í™”ì‚´í‘œ = ë‚´ìš©ì´ ì™¼ìª½ìœ¼ë¡œ í¼ì³ì§ */}
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M15 18l-6-6 6-6" />
          </svg>
        </button>

        {/* ë„êµ¬ ì´ëª¨ì§€ */}
        <span style={{ fontSize: '1.1rem', lineHeight: 1, flexShrink: 0 }}>{emoji}</span>

        {/* ë„êµ¬ ì´ë¦„ (ì„¸ë¡œ í…ìŠ¤íŠ¸) */}
        <span style={{
          writingMode: 'vertical-rl',
          textOrientation: 'upright',
          fontSize: '0.7rem',
          color: '#777',
          fontWeight: 500,
          letterSpacing: '0.04em',
          userSelect: 'none',
          whiteSpace: 'nowrap',
        }}>
          {title.replace(/^.\s*/, '')}
        </span>
      </div>
    );
  }

  // â”€â”€ í¼ì³ì§„ ìƒíƒœ (ì±„íŒ…ê³¼ 5:5 ë¶„í• ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  return (
    <div style={{
      flex: 1,
      minWidth: 0,
      borderLeft: '1px solid #e9e9e7',
      background: '#ffffff',
      display: 'flex',
      flexDirection: 'column',
      overflow: 'hidden',
    }}>
      {/* í—¤ë” */}
      <div style={{
        padding: '0 0.75rem 0 1rem',
        height: '40px',
        borderBottom: '1px solid #e9e9e7',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        flexShrink: 0,
        background: '#f7f6f3',
      }}>
        <span style={{ fontSize: '0.8rem', fontWeight: 600, color: '#37352f' }}>
          {title}
        </span>

        <div style={{ display: 'flex', alignItems: 'center', gap: '0.15rem' }}>
          {/* ì ‘ê¸° ë²„íŠ¼ */}
          <button
            onClick={onToggle}
            title="ë¯¸ë¦¬ë³´ê¸° ì ‘ê¸°"
            style={{
              width: '26px', height: '26px',
              display: 'flex', alignItems: 'center', justifyContent: 'center',
              border: 'none', background: 'transparent', cursor: 'pointer',
              color: '#7e7e7e', borderRadius: '4px',
            }}
            onMouseEnter={e => (e.currentTarget.style.background = 'rgba(0,0,0,0.06)')}
            onMouseLeave={e => (e.currentTarget.style.background = 'transparent')}
          >
            {/* ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ = ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì ‘í˜ */}
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
              <path d="M9 18l6-6-6-6" />
            </svg>
          </button>

          {/* ë‹«ê¸° ë²„íŠ¼ */}
          <button
            onClick={onClose}
            title="ë¯¸ë¦¬ë³´ê¸° ë‹«ê¸°"
            style={{
              width: '26px', height: '26px',
              display: 'flex', alignItems: 'center', justifyContent: 'center',
              border: 'none', background: 'transparent', cursor: 'pointer',
              color: '#7e7e7e', borderRadius: '4px',
            }}
            onMouseEnter={e => (e.currentTarget.style.background = 'rgba(0,0,0,0.06)')}
            onMouseLeave={e => (e.currentTarget.style.background = 'transparent')}
          >
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
              <path d="M18 6L6 18M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      {/* ì½˜í…ì¸  */}
      <div style={{ flex: 1, overflow: 'hidden', display: 'flex', flexDirection: 'column', minHeight: 0 }}>
        {tool === 'greetings' && (
          <GreetingDisplay
            greetingText={String(data?.greeting || '')}
            greetingType={String(data?.title || 'ì¸ì‚¬ë§ì”€')}
            isLoading={isLoading}
          />
        )}

        {tool === 'press-release' && (
          <PressReleaseDisplay
            data={data ?? {}}
            isLoading={isLoading}
          />
        )}

        {tool === 'merit-citation' && (
          <CitationDisplay
            citationText={String(data?.citation || '')}
            isLoading={isLoading}
          />
        )}

        {tool === 'report' && (
          isLoading || !data ? (
            <PanelLoading text="ë³´ê³ ì„œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..." />
          ) : (
            <ReportViewer reportData={data} />
          )
        )}

        {tool === 'scenario' && (
          isLoading || !data?.content ? (
            <PanelLoading text="ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..." />
          ) : (
            <ScenarioViewer
              script={{
                content: String(data.content),
                estimatedDuration: 0,
                tips: [],
                metadata: (data.metadata as Record<string, unknown>) || {},
              }}
              originalContent=""
              template={String((data.metadata as Record<string, unknown>)?.template || '')}
              settings={{}}
            />
          )
        )}

        {tool === 'ppt' && (
          isLoading || !data?.slides ? (
            <PanelLoading text="PPTë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..." />
          ) : (
            <PPTViewer slides={data.slides as SlideType[]} />
          )
        )}
      </div>
    </div>
  );
}
