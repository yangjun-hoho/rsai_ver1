# 관리자 패널 설계 문서

> 사이드바 하단 ⚙️ 관리자 메뉴 → `/admin` 페이지
> `role === 'admin'` 인 경우에만 접근 가능

---

## 1. 목표

코드 수정 없이 UI에서 직접 관리할 수 있는 관리자 전용 대시보드 구축

| 탭 | 역할 |
|----|------|
| 대시보드 | 시스템 현황 한눈에 보기 |
| 사용자 관리 | 가입자 목록 / 권한 변경 / 비활성화 |
| 게시판 관리 | 전체 글 조회 / 삭제 / 공지 고정 |
| PII 필터 설정 | 차단 패턴 CRUD / 활성화 토글 |

---

## 2. UI 레이아웃

```
┌─────────────────────────────────────────────────────┐
│  ⚙️ 관리자 패널                          [메인으로]  │
├──────────────┬──────────────────────────────────────┤
│              │                                      │
│  📊 대시보드 │   [선택된 탭 내용]                    │
│  👥 사용자   │                                      │
│  📋 게시판   │                                      │
│  🛡️ PII 필터 │                                      │
│              │                                      │
└──────────────┴──────────────────────────────────────┘
```

---

## 3. 탭별 상세 설계

### 탭 1 — 대시보드

시스템 현황을 카드 형태로 표시

```
┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
│ 전체 회원 │ │ 오늘 가입 │ │ 전체 게시│ │PII 감지수│
│   128명   │ │    3명    │ │  글 47개  │ │  이번달12│
└──────────┘ └──────────┘ └──────────┘ └──────────┘

최근 가입자 5명
최근 게시글 5개
PII 감지 최근 로그
```

---

### 탭 2 — 사용자 관리

```
[검색: 별칭으로 검색...]

번호  별칭       역할        가입일       상태      액션
────────────────────────────────────────────────────────
1    홍길동     일반사용자   2026-02-01   활성    [관리자 권한] [비활성화]
2    김철수     관리자       2026-01-15   활성    [권한 해제]   [비활성화]
3    이영희     일반사용자   2026-02-27   비활성  [관리자 권한] [활성화]
```

**기능:**
- 별칭 검색
- 역할 변경: `user` ↔ `admin`
- 계정 활성/비활성화 (비활성화 시 로그인 차단)
- 탈퇴 처리 (게시글 포함 삭제)

---

### 탭 3 — 게시판 관리

```
[검색: 제목/작성자...]   [공지만 보기 ☐]

번호  제목                작성자  조회  작성일       액션
──────────────────────────────────────────────────────────
📌47  [공지] 시스템 안내   관리자   120  2026-02-27  [공지 해제] [삭제]
46   오늘 점심 어디가요?   홍길동    15  2026-02-27  [공지 설정] [삭제]
45   업무 팁 공유합니다    김철수    32  2026-02-26  [공지 설정] [삭제]
```

**기능:**
- 전체 글 목록 (본인 글 아니어도 삭제 가능)
- 공지 고정/해제 (고정 글은 목록 최상단 표시)
- 글 내용 미리보기

---

### 탭 4 — PII 필터 설정

핵심 탭. 패턴을 DB에서 관리하여 코드 수정 없이 운영 가능.

```
[+ 새 패턴 추가]

활성  종류           정규식 패턴               수정 안내 메시지               액션
──────────────────────────────────────────────────────────────────────────────
 ✅   주민등록번호   \d{6}-[1-4]\d{6}          숫자 패턴이 주민번호와...    [수정] [삭제]
 ✅   휴대전화번호   01[016789]-?\d{3,4}-?\d{4} 전화번호 형식이 감지...     [수정] [삭제]
 ✅   이메일 주소    [a-zA-Z0-9._%+\-]+@...     이메일 주소가 포함...        [수정] [삭제]
 ❌   계좌번호       \d{3,4}-\d{2,6}-\d{4,8}   계좌번호 형식이 감지...     [수정] [삭제]
```

**새 패턴 추가 폼:**
```
종류명:       [ 여권번호              ]
정규식:       [ [A-Z]\d{8}           ]
수정 안내:    [ 여권번호가 포함되어 있습니다. ... ]
활성화:       [✅]
              [저장]  [취소]
```

**패턴 테스트 기능:**
```
테스트 문자열 입력: [ 안녕하세요 제 번호는 010-1234-5678입니다 ]
                    [테스트 실행]
결과: ⚠️ 휴대전화번호 패턴 감지됨
```

---

## 4. DB 변경사항

### app.db에 추가할 테이블

```sql
-- PII 패턴 (DB 관리로 동적 운영)
CREATE TABLE pii_patterns (
  id         INTEGER PRIMARY KEY AUTOINCREMENT,
  type       TEXT    NOT NULL,          -- 표시 이름 (예: '주민등록번호')
  regex      TEXT    NOT NULL,          -- 정규식 문자열
  hint       TEXT    NOT NULL,          -- 사용자 안내 메시지
  is_active  INTEGER NOT NULL DEFAULT 1, -- 1=활성, 0=비활성
  created_at TEXT    NOT NULL DEFAULT (datetime('now'))
);

-- 사용자 활성화 상태 (users 테이블에 컬럼 추가)
ALTER TABLE users ADD COLUMN is_active INTEGER NOT NULL DEFAULT 1;

-- 게시글 공지 고정 (posts 테이블에 컬럼 추가)
ALTER TABLE posts ADD COLUMN is_pinned INTEGER NOT NULL DEFAULT 0;

-- PII 감지 로그 (대시보드 통계용)
CREATE TABLE pii_logs (
  id           INTEGER PRIMARY KEY AUTOINCREMENT,
  pattern_type TEXT    NOT NULL,    -- 감지된 패턴 종류
  path         TEXT    NOT NULL,    -- 감지된 API 경로
  detected_at  TEXT    NOT NULL DEFAULT (datetime('now'))
  -- 원본 텍스트는 저장하지 않음 (개인정보 보호)
);
```

---

## 5. API 설계

```
app/api/admin/
├── stats/route.ts              GET  대시보드 통계
├── users/
│   ├── route.ts                GET  사용자 목록 (페이지네이션)
│   └── [id]/route.ts           PUT  역할/활성화 변경 / DELETE 탈퇴
├── posts/
│   ├── route.ts                GET  전체 게시글 목록
│   └── [id]/route.ts           PUT  공지 설정 / DELETE 삭제
└── pii-patterns/
    ├── route.ts                GET 목록 / POST 추가
    └── [id]/route.ts           PUT 수정(활성화 토글 포함) / DELETE 삭제
```

**모든 `/api/admin/*` 라우트는 middleware에서 `role === 'admin'` 검증**

---

## 6. 파일 구조

```
app/
├── admin/
│   └── page.tsx                ← 관리자 패널 (탭 기반 SPA)
└── api/
    └── admin/
        ├── stats/route.ts
        ├── users/route.ts
        ├── users/[id]/route.ts
        ├── posts/route.ts
        ├── posts/[id]/route.ts
        ├── pii-patterns/route.ts
        └── pii-patterns/[id]/route.ts

lib/
└── app-db/
    ├── admin.ts                ← 관리자용 DB 쿼리 (통계, 사용자 관리)
    └── pii-patterns.ts         ← PII 패턴 CRUD
```

---

## 7. PII 필터 동작 변경

현재: 코드에 패턴 하드코딩 → 수정 시 재배포 필요
변경: DB에서 활성 패턴 조회 → UI로 실시간 관리

```
기존 piiFilter.ts
  const PII_PATTERNS = [ ... 하드코딩 ... ]

변경 후
  const patterns = db.prepare(
    `SELECT * FROM pii_patterns WHERE is_active = 1`
  ).all()
```

**캐싱 전략**: 매 요청마다 DB 조회는 비효율적
→ 모듈 레벨 캐시 (1분 TTL) 사용, 패턴 수정 시 캐시 무효화

---

## 8. 사이드바 변경

```
현재 하단 [설정] 버튼 → 관리자인 경우 [⚙️ 관리자] 버튼으로 교체
role !== 'admin' 이면 표시하지 않음
```

구현:
- 사이드바에서 `/api/auth/me` 호출하여 role 확인
- `role === 'admin'`이면 하단에 관리자 버튼 표시
- 클릭 시 `/admin` 페이지 이동

---

## 9. 보안 체크리스트

| 항목 | 방법 |
|------|------|
| 관리자 페이지 접근 제한 | middleware에서 role 체크 |
| API 권한 검증 | 모든 `/api/admin/*`에서 role 재확인 |
| PII 로그에 원본 미저장 | 패턴 종류와 경로만 기록 |
| 사용자 삭제 시 게시글 처리 | CASCADE 삭제 (DB FK 설정) |

---

## 10. 구현 순서 (Phase)

| Phase | 내용 |
|-------|------|
| 1 | DB 테이블 추가 + PII 패턴 관리 탭 (핵심) |
| 2 | 사용자 관리 탭 |
| 3 | 게시판 관리 탭 + 공지 기능 |
| 4 | 대시보드 통계 + PII 감지 로그 |

---

*작성일: 2026-02-27*
