'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import PPTInputForm from '@/lib/work-support/ppt-converter/InputForm';
import PPTViewer, { type Slide, type TemplateId } from '@/lib/work-support/ppt-converter/PPTViewer';

export default function PPTConverterPage() {
  const router = useRouter();
  const [slides, setSlides] = useState<Slide[]>([]);
  const [isGenerating, setIsGenerating] = useState(false);
  const [isDownloading, setIsDownloading] = useState(false);
  const [error, setError] = useState('');
  const [uploadedFileInfo, setUploadedFileInfo] = useState<{ name: string; size: number } | null>(null);
  const [pptTitle, setPptTitle] = useState('í”„ë ˆì  í…Œì´ì…˜');
  const [selectedTemplate, setSelectedTemplate] = useState<TemplateId>('template1');

  useEffect(() => { document.title = 'PPT ë³€í™˜ê¸° | ì•„ë ˆìŠ¤ AI'; }, []);

  async function handleGenerate(data: {
    content: string; title: string; slideCount: number;
    includeTitle: boolean; includeIndex: boolean; includeConclusion: boolean;
  }) {
    setIsGenerating(true);
    setError('');
    setPptTitle(data.title);
    try {
      const response = await fetch('/api/work-support/ppt-converter/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error((errorData as { error?: string }).error || 'PPT ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
      const result = await response.json();
      setSlides(result.slides);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'PPT ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setIsGenerating(false);
    }
  }

  async function handleFileUpload(file: File): Promise<string> {
    const formData = new FormData();
    formData.append('file', file);
    const response = await fetch('/api/work-support/ppt-converter/upload', { method: 'POST', body: formData });
    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error((err as { error?: string }).error || 'íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
    const result = await response.json();
    setUploadedFileInfo({ name: file.name, size: file.size });
    return result.text;
  }

  async function handleDownload() {
    if (!slides.length) return;
    setIsDownloading(true);
    try {
      const response = await fetch('/api/work-support/ppt-converter/download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slides, title: pptTitle, template: selectedTemplate }),
      });
      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error((err as { error?: string }).error || 'PPT ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
      }
      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${pptTitle}.pptx`;
      a.click();
      URL.revokeObjectURL(url);
    } catch (err) {
      alert(err instanceof Error ? err.message : 'PPT ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setIsDownloading(false);
    }
  }

  return (
    <div className="page-container">
      <header className="page-header">
        <div className="header-content">
          <button className="back-button" onClick={() => router.back()} aria-label="ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
          </button>
          <h1>ğŸ–¥ï¸ PPT ë³€í™˜ê¸°</h1>
        </div>
      </header>
      <div className="page-content">
        <div className="content-container">
          <div className="content-layout">
            <div className="form-section" style={{ width: '380px' }}>
              <PPTInputForm
                onGenerate={handleGenerate}
                onFileUpload={handleFileUpload}
                isGenerating={isGenerating}
                uploadedFileInfo={uploadedFileInfo}
              />
              {error && <div className="error-message" role="alert" style={{ marginTop: '0.5rem' }}>{error}</div>}
            </div>

            <div className="result-section">
              {isGenerating ? (
                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '100%', gap: '1rem' }}>
                  <div className="loading-spinner" />
                  <p style={{ color: 'var(--text-secondary)' }}>PPTë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
              ) : slides.length > 0 ? (
                <PPTViewer
                  slides={slides}
                  onSlidesChange={setSlides}
                  onDownload={handleDownload}
                  isDownloading={isDownloading}
                />
              ) : (
                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '100%', padding: '2rem', textAlign: 'center', color: 'var(--text-muted)' }}>
                  <span style={{ fontSize: '3rem', marginBottom: '1rem', opacity: 0.5 }}>ğŸ–¥ï¸</span>
                  <h3 style={{ margin: '0 0 0.5rem 0', color: 'var(--text-secondary)' }}>PPT ìƒì„± ëŒ€ê¸° ì¤‘</h3>
                  <p style={{ margin: 0, fontSize: '0.85rem' }}>íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
